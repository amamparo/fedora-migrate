---
# Role: repos â€” Configure package sources before anything else

- name: Install RPM Fusion free repository
  ansible.builtin.dnf:
    name: "https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-{{ ansible_distribution_major_version }}.noarch.rpm"
    state: present
    disable_gpg_check: true
  become: true
  when: rpmfusion_free | bool

- name: Install RPM Fusion nonfree repository
  ansible.builtin.dnf:
    name: "https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-{{ ansible_distribution_major_version }}.noarch.rpm"
    state: present
    disable_gpg_check: true
  become: true
  when: rpmfusion_nonfree | bool

- name: Enable COPR repositories
  ansible.builtin.command:
    cmd: "dnf copr enable -y {{ item }}"
  become: true
  loop: "{{ copr_repos }}"
  when: copr_repos | length > 0
  register: copr_result
  changed_when: "'enabled' in copr_result.stdout | default('')"
  failed_when: copr_result.rc != 0 and 'already enabled' not in copr_result.stderr | default('')

- name: Copy third-party repo files
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: /etc/yum.repos.d/
    owner: root
    group: root
    mode: "0644"
  become: true
  loop: "{{ third_party_repo_files }}"
  when: third_party_repo_files | length > 0

- name: Refresh DNF cache
  ansible.builtin.dnf:
    update_cache: true
  become: true
  when: rpmfusion_free | bool or rpmfusion_nonfree | bool or copr_repos | length > 0 or third_party_repo_files | length > 0
