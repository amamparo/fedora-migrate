---
# Role: thirdparty â€” Install automatable third-party software, flag the rest

# -- Custom .desktop files ---------------------------------------------------

- name: Ensure user applications directory exists
  ansible.builtin.file:
    path: "{{ target_home }}/.local/share/applications"
    state: directory
    owner: "{{ target_user }}"
    mode: "0755"

- name: Copy custom .desktop files
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "{{ target_home }}/.local/share/applications/"
    owner: "{{ target_user }}"
    mode: "0644"
  loop: "{{ lookup('fileglob', role_path + '/files/desktop-files/*.desktop', wantlist=True) }}"
  loop_control:
    label: "{{ item | basename }}"

# -- ~/Applications directory ------------------------------------------------

- name: Ensure ~/Applications exists
  ansible.builtin.file:
    path: "{{ target_home }}/Applications"
    state: directory
    owner: "{{ target_user }}"
    mode: "0755"
  when: lookup('fileglob', role_path + '/files/applications/*', wantlist=True) | length > 0

# -- ~/opt directory (user-installed packages like REAPER) -------------------

- name: Copy ~/opt programs
  ansible.builtin.copy:
    src: user-opt/
    dest: "{{ target_home }}/opt/"
    owner: "{{ target_user }}"
    mode: preserve
  when: lookup('first_found', dict(files=['user-opt/'], paths=[role_path + '/files'], skip=true)) | length > 0

# -- ~/.local/bin (user-installed binaries) ----------------------------------

- name: Ensure ~/.local/bin exists
  ansible.builtin.file:
    path: "{{ target_home }}/.local/bin"
    state: directory
    owner: "{{ target_user }}"
    mode: "0755"
  when: lookup('first_found', dict(files=['user-local-bin/'], paths=[role_path + '/files'], skip=true)) | length > 0

- name: Copy ~/.local/bin binaries
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "{{ target_home }}/.local/bin/"
    owner: "{{ target_user }}"
    mode: preserve
  loop: "{{ lookup('fileglob', role_path + '/files/user-local-bin/*', wantlist=True) }}"
  loop_control:
    label: "{{ item | basename }}"
  when: item | basename != 'listing.txt'

# -- Generate MANUAL_STEPS.md for non-automatable software -------------------

- name: Generate MANUAL_STEPS.md
  ansible.builtin.template:
    src: manual_steps.md.j2
    dest: "{{ playbook_dir }}/MANUAL_STEPS.md"
    mode: "0644"
  when: thirdparty_manual | length > 0
